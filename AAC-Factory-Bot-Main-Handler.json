{
  "nodes": [
    {
      "parameters": {
        "updates": [
          "message",
          "callback_query"
        ],
        "additionalFields": {}
      },
      "name": "Telegram Bot Trigger",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1,
      "position": [
        0,
        -400
      ],
      "id": "bf069b99-22bb-42a2-a7af-73945968a823",
      "webhookId": "dd2819bd-8445-4f23-aaeb-7419f1c74634",
      "credentials": {
        "telegramApi": {
          "id": "unobc0pPuBUekcS2",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const item = items[0].json;\nlet eventType = 'unknown';\nlet userId = null;\nlet chatId = null;\nlet messageText = '';\nlet callbackData = '';\nlet hasPhoto = false;\n\ntry {\n  if (item.message) {\n    userId = item.message.from.id;\n    chatId = item.message.chat.id;\n    messageText = item.message.text || '';\n    hasPhoto = !!(item.message.photo && item.message.photo.length > 0);\n    \n    const text = messageText.toLowerCase().trim();\n\n    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥\n    if (text.startsWith('/start')) {\n      eventType = 'start';\n    } else if (text.startsWith('/–º–æ—è_—Å–º–µ–Ω–∞') || text.startsWith('/shift') || text === 'üìä –º–æ—è —Å–º–µ–Ω–∞') {\n      eventType = 'shift_management';\n    } else if (text.startsWith('/–±—Ä–∞–∫') || text.startsWith('/defect') || text === '‚ö†Ô∏è —Å–æ–æ–±—â–∏—Ç—å –æ –±—Ä–∞–∫–µ' || hasPhoto) {\n      eventType = 'defect_report';\n    } else if (text.startsWith('/—Ä–µ—Ü–µ–ø—Ç') || text.startsWith('/recipe') || text === 'üìã —Ä–µ—Ü–µ–ø—Ç—ã') {\n      eventType = 'recipe_search';\n    } else if (text.startsWith('/–∑–∞–≥—Ä—É–∑–∫–∞') || text.startsWith('/load') || text.startsWith('/–æ—Å—Ç–∞—Ç–∫–∏') || text.startsWith('/stock') || text === 'üì¶ –æ—Å—Ç–∞—Ç–∫–∏') {\n      eventType = 'material_management';\n    } else if (text.startsWith('/–ø–æ–º–æ—â—å') || text.startsWith('/help')) {\n      eventType = 'help';\n    }\n\n  } else if (item.callback_query) {\n    userId = item.callback_query.from.id;\n    chatId = item.callback_query.message.chat.id;\n    callbackData = item.callback_query.data;\n\n    if (callbackData.startsWith('shift_')) {\n      eventType = 'shift_management';\n    } else if (callbackData.startsWith('defect_')) {\n      eventType = 'defect_report';\n    } else if (callbackData.startsWith('material_')) {\n      eventType = 'material_management';\n    } else if (callbackData.startsWith('recipe_')) {\n      eventType = 'recipe_search';\n    }\n  }\n\n  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö\n  if (!userId || !chatId) {\n    throw new Error('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');\n  }\n\n  return [{\n    json: {\n      eventType: eventType,\n      userId: userId,\n      chatId: chatId,\n      messageText: messageText,\n      callbackData: callbackData,\n      hasPhoto: hasPhoto,\n      originalData: item\n    }\n  }];\n} catch (error) {\n  console.error('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–±—ã—Ç–∏—è:', error.message);\n  return [{\n    json: {\n      eventType: 'error',\n      error: error.message,\n      userId: userId,\n      chatId: chatId,\n      originalData: item\n    }\n  }];\n}"
      },
      "name": "Process Event - FIXED",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        220,
        -400
      ],
      "id": "7986ede6-8bd9-4322-b392-0ef853c08f46"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "start-condition",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.eventType }}",
                    "rightValue": "start"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "start"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "shift-condition",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.eventType }}",
                    "rightValue": "shift_management"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "shift_management"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "defect-condition",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.eventType }}",
                    "rightValue": "defect_report"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "defect_report"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "recipe-condition",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.eventType }}",
                    "rightValue": "recipe_search"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "recipe_search"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "material-condition",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.eventType }}",
                    "rightValue": "material_management"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "material_management"
            },
            {
              "conditions": {
                "options": {
                  "version": 2,
                  "leftValue": "",
                  "caseSensitive": true,
                  "typeValidation": "strict"
                },
                "combinator": "and",
                "conditions": [
                  {
                    "id": "help-condition",
                    "operator": {
                      "name": "filter.operator.equals",
                      "type": "string",
                      "operation": "equals"
                    },
                    "leftValue": "={{ $json.eventType }}",
                    "rightValue": "help"
                  }
                ]
              },
              "renameOutput": true,
              "outputKey": "help"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "name": "Route Events - COMPLETELY FIXED",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        440,
        -400
      ],
      "id": "a42a45e2-5a18-4469-bf07-298d767adaa9"
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "üè≠ *–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –∑–∞–≤–æ–¥ –ê–ê–°!*\n\n–Ø –≤–∞—à —Ü–∏—Ñ—Ä–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–æ–º.\n\nüìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n/–º–æ—è_—Å–º–µ–Ω–∞ - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–º–µ–Ω–æ–π\n/—Ä–µ—Ü–µ–ø—Ç [–Ω–∞–∑–≤–∞–Ω–∏–µ] - –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–∞\n/–±—Ä–∞–∫ - –°–æ–æ–±—â–∏—Ç—å –æ –±—Ä–∞–∫–µ (+ —Ñ–æ—Ç–æ)\n/–∑–∞–≥—Ä—É–∑–∫–∞ [–±—É–Ω–∫–µ—Ä] [–º–∞—Ç–µ—Ä–∏–∞–ª] [–∫–æ–ª-–≤–æ] - –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–∞\n/–æ—Å—Ç–∞—Ç–∫–∏ - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏\n/–ø–æ–º–æ—â—å - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n‚ö° *–î–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é.*",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Welcome - ENHANCED",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        660,
        -820
      ],
      "id": "146f154b-1b39-4ff1-b79a-402ca1393631",
      "webhookId": "491132c6-e5fc-4baf-897f-5424c640042d",
      "credentials": {
        "telegramApi": {
          "id": "unobc0pPuBUekcS2",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "workflowId": "{{ $vars.SHIFT_WORKFLOW_ID || '–£–ö–ê–ñ–ò–¢–ï_ID_WORKFLOW_–°–ú–ï–ù' }}",
        "options": {}
      },
      "name": "Execute Shift Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        660,
        -680
      ],
      "id": "67a5c00d-df77-4e2a-9afc-7d0487f3d9ae"
    },
    {
      "parameters": {
        "workflowId": "{{ $vars.DEFECT_WORKFLOW_ID || '–£–ö–ê–ñ–ò–¢–ï_ID_WORKFLOW_–î–ï–§–ï–ö–¢–û–í' }}",
        "options": {}
      },
      "name": "Execute Defect Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        660,
        -520
      ],
      "id": "37ddbbcc-33e4-4c06-88a9-ff6184888a30"
    },
    {
      "parameters": {
        "workflowId": "{{ $vars.RECIPE_WORKFLOW_ID || '–£–ö–ê–ñ–ò–¢–ï_ID_WORKFLOW_–†–ï–¶–ï–ü–¢–û–í' }}",
        "options": {}
      },
      "name": "Execute Recipe Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        660,
        -360
      ],
      "id": "cce338e5-c95f-49a8-9fd2-230d2e09e641"
    },
    {
      "parameters": {
        "workflowId": "{{ $vars.MATERIAL_WORKFLOW_ID || '–£–ö–ê–ñ–ò–¢–ï_ID_WORKFLOW_–ú–ê–¢–ï–†–ò–ê–õ–û–í' }}",
        "options": {}
      },
      "name": "Execute Material Workflow",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        660,
        -200
      ],
      "id": "01fb6899-2f0d-4120-82da-7aebd010bbdf"
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "üè≠ *–°–ø—Ä–∞–≤–∫–∞ –ø–æ –∫–æ–º–∞–Ω–¥–∞–º –∑–∞–≤–æ–¥–∞ –ê–ê–°*\n\nüìã *–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n‚Ä¢ `/–º–æ—è_—Å–º–µ–Ω–∞` - –ù–∞—á–∞—Ç—å/–∑–∞–≤–µ—Ä—à–∏—Ç—å —Å–º–µ–Ω—É, —É–π—Ç–∏ –Ω–∞ –æ–±–µ–¥\n‚Ä¢ `/—Ä–µ—Ü–µ–ø—Ç D500` - –ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é\n‚Ä¢ `/–±—Ä–∞–∫` - –°–æ–æ–±—â–∏—Ç—å –æ –¥–µ—Ñ–µ–∫—Ç–µ (–ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ)\n‚Ä¢ `/–∑–∞–≥—Ä—É–∑–∫–∞ –ë–¶1 —Ü–µ–º–µ–Ω—Ç 50` - –ó–∞–≥—Ä—É–∑–∏—Ç—å 50 —Ç–æ–Ω–Ω —Ü–µ–º–µ–Ω—Ç–∞ –≤ –±—É–Ω–∫–µ—Ä –ë–¶1\n‚Ä¢ `/–æ—Å—Ç–∞—Ç–∫–∏` - –ü–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤\n\nüí° *–°–æ–≤–µ—Ç—ã:*\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞\n‚Ä¢ –ü—Ä–∏ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ –±—Ä–∞–∫–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ —Ñ–æ—Ç–æ\n‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç–æ—á–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –∏ –±—É–Ω–∫–µ—Ä–æ–≤\n\n‚ùì –í–æ–∑–Ω–∏–∫–ª–∏ –≤–æ–ø—Ä–æ—Å—ã? –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—é —Å–º–µ–Ω—ã.",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Help",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        660,
        -40
      ],
      "id": "0d1e8e05-3ada-40ad-9aa5-85877dbaa4bc",
      "webhookId": "d0d62a5f-bef3-495b-b5c1-8585f359f277",
      "credentials": {
        "telegramApi": {
          "id": "unobc0pPuBUekcS2",
          "name": "Telegram account 2"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{$json.chatId}}",
        "text": "‚ùå *–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞*\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.\n\n–û—à–∏–±–∫–∞: {{$json.error}}",
        "additionalFields": {
          "parse_mode": "Markdown"
        }
      },
      "name": "Send Error Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        660,
        140
      ],
      "id": "a4d1b498-d27f-41da-860e-920db835bfa8",
      "webhookId": "c8c44218-b7dc-4e9e-8942-86c79ace8679",
      "credentials": {
        "telegramApi": {
          "id": "unobc0pPuBUekcS2",
          "name": "Telegram account 2"
        }
      }
    }
  ],
  "connections": {
    "Telegram Bot Trigger": {
      "main": [
        [
          {
            "node": "Process Event - FIXED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Event - FIXED": {
      "main": [
        [
          {
            "node": "Route Events - COMPLETELY FIXED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Events - COMPLETELY FIXED": {
      "main": [
        [
          {
            "node": "Send Welcome - ENHANCED",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Shift Workflow",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Defect Workflow",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Recipe Workflow",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Execute Material Workflow",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Help",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Error Message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "648299e299cac772364408cdc8842b742b620f4e23b0830e3cf1308d7569bc02"
  }
}
