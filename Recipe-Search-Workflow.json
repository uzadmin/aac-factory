{
  "name": "Recipe Search Workflow - FIXED",
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [240, 300]
    },
    {
      "parameters": {
        "jsCode": "const messageText = $json.messageText || '';\nconst cleanText = messageText.trim();\n\n// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –ø–æ–∏—Å–∫–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞\nlet searchTerm = '';\n\nif (cleanText === 'üìã —Ä–µ—Ü–µ–ø—Ç—ã' || cleanText.toLowerCase() === '—Ä–µ—Ü–µ–ø—Ç—ã') {\n  // –ï—Å–ª–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–∞–ª–∏ –∫–Ω–æ–ø–∫—É \"–†–µ—Ü–µ–ø—Ç—ã\", –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—Å–µ\n  searchTerm = '';\n} else {\n  // –£–¥–∞–ª—è–µ–º –∫–æ–º–∞–Ω–¥—É –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –∑–∞–ø—Ä–æ—Å\n  searchTerm = cleanText\n    .replace(/^\\/—Ä–µ—Ü–µ–ø—Ç\\s*/i, '')\n    .replace(/^\\/recipe\\s*/i, '')\n    .replace(/^—Ä–µ—Ü–µ–ø—Ç\\s*/i, '')\n    .replace(/^recipe\\s*/i, '')\n    .trim();\n}\n\nif (!searchTerm) {\n  return { \n    show_all: true,\n    message: 'üìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã*\\n\\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏–ª–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã –Ω–∏–∂–µ.\\n\\nüí° *–ü—Ä–∏–º–µ—Ä:* `/—Ä–µ—Ü–µ–ø—Ç D500` –∏–ª–∏ `/—Ä–µ—Ü–µ–ø—Ç –±–ª–æ–∫`'\n  };\n}\n\nconsole.log(`–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–∞ –ø–æ –∑–∞–ø—Ä–æ—Å—É: \"${searchTerm}\"`);\nreturn { \n  searchTerm: searchTerm,\n  show_all: false \n};"
      },
      "name": "Parse Search Term - FIXED",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [460, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.show_all}}",
              "value2": true,
              "operation": "equal"
            }
          ]
        }
      },
      "name": "Check Show All",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [680, 300]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT recipe_id, recipe_name, product_code, product_type, cement_kg, lime_kg, sand_kg, water_liters, aluminum_powder_kg, mixing_time_minutes, density_kg_m3, strength_mpa FROM recipes WHERE is_active = 1 ORDER BY recipe_name LIMIT 10;",
        "options": {}
      },
      "name": "Get All Recipes",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 1,
      "position": [900, 200]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "CALL SearchRecipes(?)",
        "options": {
          "parameters": "=[{{$json.searchTerm}}]"
        }
      },
      "name": "Search Recipes MySQL",
      "type": "n8n-nodes-base.mySql",
      "typeVersion": 1,
      "position": [900, 400]
    },
    {
      "parameters": {
        "jsCode": "// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ö—Ä–∞–Ω–∏–º–æ–π –ø—Ä–æ—Ü–µ–¥—É—Ä—ã\nconst results = items[0].json;\nlet recipes = [];\n\n// –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ä–∞–∑–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞\nif (Array.isArray(results)) {\n  recipes = results;\n} else if (results && results[0] && Array.isArray(results[0])) {\n  recipes = results[0];\n} else if (results && Array.isArray(results.data)) {\n  recipes = results.data;\n}\n\nconsole.log('–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã:', JSON.stringify(recipes, null, 2));\n\nif (!recipes || recipes.length === 0) {\n  return { \n    error: true,\n    message: 'üîç *–†–µ—Ü–µ–ø—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã*\\n\\n–ü–æ –≤–∞—à–µ–º—É –∑–∞–ø—Ä–æ—Å—É –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\\n\\nüí° *–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:*\\n‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –Ω–∞–ø–∏—Å–∞–Ω–∏—è\\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è\\n‚Ä¢ –ò—Å–∫–∞—Ç—å –ø–æ —Ç–∏–ø—É –ø—Ä–æ–¥—É–∫—Ç–∞ (–±–ª–æ–∫, –ø–∞–Ω–µ–ª—å)\\n\\nüìã –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ `/—Ä–µ—Ü–µ–ø—Ç`'\n  };\n}\n\nlet message = 'üìã *–ù–∞–π–¥–µ–Ω–Ω—ã–µ —Ä–µ—Ü–µ–ø—Ç—ã:*\\n\\n';\n\nfor (let i = 0; i < recipes.length && i < 5; i++) {\n  const recipe = recipes[i];\n  \n  message += `üèóÔ∏è **${recipe.recipe_name}**\\n`;\n  \n  if (recipe.product_code) {\n    message += `üìã –ö–æ–¥: ${recipe.product_code}\\n`;\n  }\n  \n  if (recipe.density_kg_m3) {\n    message += `‚öñÔ∏è –ü–ª–æ—Ç–Ω–æ—Å—Ç—å: ${recipe.density_kg_m3} –∫–≥/–º¬≥\\n`;\n  }\n  \n  message += `\\n*–°–æ—Å—Ç–∞–≤ –Ω–∞ 1 –º¬≥:*\\n`;\n  message += `‚Ä¢ üèóÔ∏è –¶–µ–º–µ–Ω—Ç: ${recipe.cement_kg} –∫–≥\\n`;\n  message += `‚Ä¢ üèîÔ∏è –ò–∑–≤–µ—Å—Ç—å: ${recipe.lime_kg} –∫–≥\\n`;\n  message += `‚Ä¢ üèñÔ∏è –ü–µ—Å–æ–∫: ${recipe.sand_kg} –∫–≥\\n`;\n  message += `‚Ä¢ üíß –í–æ–¥–∞: ${recipe.water_liters} –ª\\n`;\n  message += `‚Ä¢ ‚ú® –ê–ª—é–º–∏–Ω–∏–π: ${recipe.aluminum_powder_kg} –∫–≥\\n`;\n  \n  if (recipe.mixing_time_minutes) {\n    message += `‚è±Ô∏è –í—Ä–µ–º—è —Å–º–µ—à–∏–≤–∞–Ω–∏—è: ${recipe.mixing_time_minutes} –º–∏–Ω\\n`;\n  }\n  \n  if (recipe.strength_mpa) {\n    message += `üí™ –ü—Ä–æ—á–Ω–æ—Å—Ç—å: ${recipe.strength_mpa} –ú–ü–∞\\n`;\n  }\n  \n  message += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\\n`;\n}\n\nif (recipes.length > 5) {\n  message += `\\nüìå –ü–æ–∫–∞–∑–∞–Ω–æ –ø–µ—Ä–≤—ã—Ö 5 –∏–∑ ${recipes.length} –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ä–µ—Ü–µ–ø—Ç–æ–≤.\\n–£—Ç–æ—á–Ω–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –¥–ª—è –±–æ–ª–µ–µ —Ç–æ—á–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞.`;\n}\n\nreturn { \n  error: false,\n  message: message \n};"
      },
      "name": "Format Recipes - FIXED",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [1120, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.error}}",
              "value2": true,
              "operation": "equal"
            }
          ]
        }
      },
      "name": "Check Format Error",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "chatId": "={{$input.item.json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "reply_markup": "{\n  \"inline_keyboard\": [\n    [{\"text\": \"üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫\", \"callback_data\": \"recipe_search_new\"}],\n    [{\"text\": \"üìã –í—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã\", \"callback_data\": \"recipe_show_all\"}]\n  ]\n}"
        }
      },
      "name": "Send Error Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1560, 240]
    },
    {
      "parameters": {
        "chatId": "={{$input.item.json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "reply_markup": "{\n  \"inline_keyboard\": [\n    [{\"text\": \"üîç –ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–∞\", \"callback_data\": \"recipe_search_new\"}],\n    [{\"text\": \"üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç\", \"callback_data\": \"recipe_save\"}]\n  ]\n}"
        }
      },
      "name": "Send Recipe Result - ENHANCED",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1560, 360]
    },
    {
      "parameters": {
        "jsCode": "const searchTerm = $('Parse Search Term - FIXED').item.json.searchTerm || '';\n\n// –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –ø–æ–º–æ—â—å—é\nconst helpMessage = `üìã *–ü–æ–∏—Å–∫ —Ä–µ—Ü–µ–ø—Ç–æ–≤ –ê–ê–°*\\n\\nüîç **–ö–∞–∫ –∏—Å–∫–∞—Ç—å:**\\n‚Ä¢ `/—Ä–µ—Ü–µ–ø—Ç D500` - –ø–æ–∏—Å–∫ –ø–æ –ø–ª–æ—Ç–Ω–æ—Å—Ç–∏\\n‚Ä¢ `/—Ä–µ—Ü–µ–ø—Ç –±–ª–æ–∫` - –ø–æ–∏—Å–∫ –ø–æ —Ç–∏–ø—É\\n‚Ä¢ `/—Ä–µ—Ü–µ–ø—Ç B2.5` - –ø–æ–∏—Å–∫ –ø–æ –ø—Ä–æ—á–Ω–æ—Å—Ç–∏\\n‚Ä¢ `/—Ä–µ—Ü–µ–ø—Ç` - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã\\n\\nüí° **–°–æ–≤–µ—Ç—ã:**\\n‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —á–∞—Å—Ç—å –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞\\n‚Ä¢ –ò—â–∏—Ç–µ –ø–æ –∫–æ–¥—É –ø—Ä–æ–¥—É–∫—Ç–∞\\n‚Ä¢ –£–∫–∞–∑—ã–≤–∞–π—Ç–µ —Ç–∏–ø –º–∞—Ç–µ—Ä–∏–∞–ª–∞\\n\\nüìù **–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**\\n\\\"–ù–∞–π—Ç–∏ —Ä–µ—Ü–µ–ø—Ç –¥–ª—è –±–ª–æ–∫–æ–≤ –ø–ª–æ—Ç–Ω–æ—Å—Ç—å—é D500\\\"\\n‚û°Ô∏è \`/—Ä–µ—Ü–µ–ø—Ç D500\``;\n\nreturn { message: helpMessage };"
      },
      "name": "Create Help Message",
      "type": "n8n-nodes-base.code",
      "typeVersion": 1,
      "position": [900, 100]
    },
    {
      "parameters": {
        "chatId": "={{$input.item.json.chatId}}",
        "text": "={{$json.message}}",
        "additionalFields": {
          "parse_mode": "Markdown",
          "reply_markup": "{\n  \"inline_keyboard\": [\n    [{\"text\": \"üìã –ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ä–µ—Ü–µ–ø—Ç—ã\", \"callback_data\": \"recipe_show_all\"}],\n    [{\"text\": \"üîç –ü—Ä–∏–º–µ—Ä –ø–æ–∏—Å–∫–∞\", \"callback_data\": \"recipe_example\"}]\n  ]\n}"
        }
      },
      "name": "Send Help Message",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1,
      "position": [1120, 100]
    }
  ],
  "connections": {
    "Start": {
      "main": [[{"node": "Parse Search Term - FIXED", "type": "main", "index": 0}]]
    },
    "Parse Search Term - FIXED": {
      "main": [[{"node": "Check Show All", "type": "main", "index": 0}]]
    },
    "Check Show All": {
      "main": [
        [{"node": "Create Help Message", "type": "main", "index": 0}],
        [{"node": "Search Recipes MySQL", "type": "main", "index": 0}]
      ]
    },
    "Create Help Message": {
      "main": [[{"node": "Send Help Message", "type": "main", "index": 0}]]
    },
    "Get All Recipes": {
      "main": [[{"node": "Format Recipes - FIXED", "type": "main", "index": 0}]]
    },
    "Search Recipes MySQL": {
      "main": [[{"node": "Format Recipes - FIXED", "type": "main", "index": 0}]]
    },
    "Format Recipes - FIXED": {
      "main": [[{"node": "Check Format Error", "type": "main", "index": 0}]]
    },
    "Check Format Error": {
      "main": [
        [{"node": "Send Error Message", "type": "main", "index": 0}],
        [{"node": "Send Recipe Result - ENHANCED", "type": "main", "index": 0}]
      ]
    }
  }
}
